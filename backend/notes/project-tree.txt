CHAT APP BACKEND - COMPLETE PROJECT TREE MAP
============================================

ğŸ“ backend/
â”œâ”€â”€ ğŸ“„ package.json
â”‚   â”œâ”€â”€ name: "backend"
â”‚   â”œâ”€â”€ version: "1.0.0"
â”‚   â”œâ”€â”€ main: "src/server.js"
â”‚   â”œâ”€â”€ scripts: { dev: "nodemon src/server.js" }
â”‚   â””â”€â”€ dependencies: [express, mongoose, bcryptjs, jsonwebtoken, cookie-parser, cors, dotenv, stream-chat, nodemon]
â”‚
â”œâ”€â”€ ğŸ“„ package-lock.json
â”‚   â””â”€â”€ Locked dependency versions
â”‚
â””â”€â”€ ğŸ“ src/
    â”œâ”€â”€ ğŸ“„ server.js (MAIN ENTRY POINT)
    â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS
    â”‚   â”‚   â”œâ”€â”€ express, dotenv
    â”‚   â”‚   â”œâ”€â”€ authRoutes, userRoutes, chatRoutes
    â”‚   â”‚   â”œâ”€â”€ connectDb, cookieParser
    â”‚   â”‚   â””â”€â”€ dotenv.config()
    â”‚   â”‚
    â”‚   â”œâ”€â”€ âš™ï¸ SERVER SETUP
    â”‚   â”‚   â”œâ”€â”€ const app = express()
    â”‚   â”‚   â”œâ”€â”€ const PORT = process.env.PORT || 3000
    â”‚   â”‚   â””â”€â”€ Middleware: express.json(), express.urlencoded(), cookieParser()
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ›£ï¸ ROUTES
    â”‚   â”‚   â”œâ”€â”€ app.use("/api/auth", authRoutes)
    â”‚   â”‚   â”œâ”€â”€ app.use("/api/user", userRoutes)
    â”‚   â”‚   â””â”€â”€ app.use("/api/chat", chatRoutes)
    â”‚   â”‚
    â”‚   â””â”€â”€ ğŸš€ SERVER START
    â”‚       â”œâ”€â”€ app.listen(PORT, callback)
    â”‚       â””â”€â”€ connectDb()
    â”‚
    â”œâ”€â”€ ğŸ“ lib/
    â”‚   â”œâ”€â”€ ğŸ“„ db.js (DATABASE CONNECTION)
    â”‚   â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: mongoose, dotenv
    â”‚   â”‚   â”œâ”€â”€ âš™ï¸ CONFIG: dotenv.config()
    â”‚   â”‚   â”œâ”€â”€ ğŸ”Œ CONNECT FUNCTION: connectDb()
    â”‚   â”‚   â”‚   â”œâ”€â”€ mongoose.connect(process.env.MONGO_URI)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Success: console.log connection host
    â”‚   â”‚   â”‚   â””â”€â”€ Error: console.log error + process.exit(1)
    â”‚   â”‚   â””â”€â”€ ğŸ“¤ EXPORT: connectDb
    â”‚   â”‚
    â”‚   â””â”€â”€ ğŸ“„ stream.js (STREAM CHAT INTEGRATION)
    â”‚       â”œâ”€â”€ ğŸ”§ IMPORTS: StreamChat, dotenv
    â”‚       â”œâ”€â”€ âš™ï¸ CONFIG: dotenv.config(), apiKey, apiSecret
    â”‚       â”œâ”€â”€ ğŸ”§ CLIENT: StreamChat.getInstance(apiKey, apiSecret)
    â”‚       â”œâ”€â”€ ğŸ‘¤ UPSERT USER: upsertStreamUser(userData)
    â”‚       â”‚   â”œâ”€â”€ Input: {id, name, image}
    â”‚       â”‚   â”œâ”€â”€ Transform: streamUser object
    â”‚       â”‚   â”œâ”€â”€ API Call: streamClient.upsertUsers([streamUser])
    â”‚       â”‚   â”œâ”€â”€ Success: return userData
    â”‚       â”‚   â””â”€â”€ Error: throw Error
    â”‚       â”œâ”€â”€ ğŸ« GENERATE TOKEN: generateStreamToken(userId)
    â”‚       â”‚   â”œâ”€â”€ Input: userId (string)
    â”‚       â”‚   â”œâ”€â”€ Validation: apiKey, apiSecret check
    â”‚       â”‚   â”œâ”€â”€ Generate: streamClient.createToken(userIdStr)
    â”‚       â”‚   â””â”€â”€ Return: token or throw Error
    â”‚       â””â”€â”€ ğŸ“¤ EXPORTS: upsertStreamUser, generateStreamToken
    â”‚
    â”œâ”€â”€ ğŸ“ models/
    â”‚   â”œâ”€â”€ ğŸ“„ User.js (USER MODEL)
    â”‚   â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: mongoose, bcrypt
    â”‚   â”‚   â”œâ”€â”€ ğŸ“‹ SCHEMA: userSchema
    â”‚   â”‚   â”‚   â”œâ”€â”€ fullName: String (required)
    â”‚   â”‚   â”‚   â”œâ”€â”€ email: String (required, unique)
    â”‚   â”‚   â”‚   â”œâ”€â”€ password: String (required, min 6)
    â”‚   â”‚   â”‚   â”œâ”€â”€ bio: String (default: "")
    â”‚   â”‚   â”‚   â”œâ”€â”€ profilePicture: String (default: "")
    â”‚   â”‚   â”‚   â”œâ”€â”€ nativeLanguage: String (default: "")
    â”‚   â”‚   â”‚   â”œâ”€â”€ learningLanguage: String (default: "")
    â”‚   â”‚   â”‚   â”œâ”€â”€ location: String (default: "")
    â”‚   â”‚   â”‚   â”œâ”€â”€ isOnboarding: Boolean (default: false)
    â”‚   â”‚   â”‚   â”œâ”€â”€ friends: [ObjectId] (ref: User)
    â”‚   â”‚   â”‚   â””â”€â”€ timestamps: true
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ” PRE-SAVE MIDDLEWARE
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: if password modified
    â”‚   â”‚   â”‚   â”œâ”€â”€ Hash: bcrypt.genSalt(10) + bcrypt.hash()
    â”‚   â”‚   â”‚   â””â”€â”€ Error: next(error)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ”‘ METHODS: matchPassword(enteredPassword)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Compare: bcrypt.compare(enteredPassword, this.password)
    â”‚   â”‚   â”‚   â””â”€â”€ Return: boolean
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ ğŸ“¤ EXPORT: User model
    â”‚   â”‚
    â”‚   â””â”€â”€ ğŸ“„ FriendRequest.js (FRIEND REQUEST MODEL)
    â”‚       â”œâ”€â”€ ğŸ”§ IMPORTS: mongoose, User
    â”‚       â”œâ”€â”€ ğŸ“‹ SCHEMA: friendRequestSchema
    â”‚       â”‚   â”œâ”€â”€ sender: ObjectId (ref: User, required)
    â”‚       â”‚   â”œâ”€â”€ recipient: ObjectId (ref: User, required)
    â”‚       â”‚   â”œâ”€â”€ status: String (enum: ["pending", "accepted"], default: "pending")
    â”‚       â”‚   â””â”€â”€ timestamps: true
    â”‚       â”‚
    â”‚       â””â”€â”€ ğŸ“¤ EXPORT: FriendRequest model
    â”‚
    â”œâ”€â”€ ğŸ“ middleware/
    â”‚   â””â”€â”€ ğŸ“„ auth.middleware.js (AUTHENTICATION MIDDLEWARE)
    â”‚       â”œâ”€â”€ ğŸ”§ IMPORTS: jwt, User
    â”‚       â”œâ”€â”€ ğŸ›¡ï¸ PROTECT ROUTE: protectRoute(req, res, next)
    â”‚       â”‚   â”œâ”€â”€ Extract: token from req.cookies.token
    â”‚       â”‚   â”œâ”€â”€ Validate: token exists
    â”‚       â”‚   â”œâ”€â”€ Verify: jwt.verify(token, JWT_SECRET_KEY)
    â”‚       â”‚   â”œâ”€â”€ Find User: User.findById(decoded.userId).select("-password")
    â”‚       â”‚   â”œâ”€â”€ Attach: req.user = user
    â”‚       â”‚   â””â”€â”€ Continue: next()
    â”‚       â”‚
    â”‚       â””â”€â”€ ğŸ“¤ EXPORT: protectRoute
    â”‚
    â”œâ”€â”€ ğŸ“ controllers/
    â”‚   â”œâ”€â”€ ğŸ“„ auth.controllers.js (AUTHENTICATION CONTROLLERS)
    â”‚   â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: jwt, User, upsertStreamUser
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ‘¤ SIGNUP: signup(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Validate: email, password, fullName
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: password length >= 6
    â”‚   â”‚   â”‚   â”œâ”€â”€ Validate: email format (regex)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: existing user
    â”‚   â”‚   â”‚   â”œâ”€â”€ Generate: random avatar URL
    â”‚   â”‚   â”‚   â”œâ”€â”€ Create: User.create()
    â”‚   â”‚   â”‚   â”œâ”€â”€ Stream: upsertStreamUser()
    â”‚   â”‚   â”‚   â”œâ”€â”€ Generate: JWT token
    â”‚   â”‚   â”‚   â”œâ”€â”€ Set Cookie: res.cookie("token", token, options)
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 201 success
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ”‘ LOGIN: login(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Validate: email, password
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: User.findOne({ email })
    â”‚   â”‚   â”‚   â”œâ”€â”€ Verify: user.matchPassword(password)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Generate: JWT token
    â”‚   â”‚   â”‚   â”œâ”€â”€ Set Cookie: res.cookie("token", token, options)
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 success
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸšª LOGOUT: logout(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Clear: res.clearCookie("token", options)
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 success
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ ğŸ“ ONBOARD: onboard(req, res)
    â”‚   â”‚       â”œâ”€â”€ Extract: userId from req.user._id
    â”‚   â”‚       â”œâ”€â”€ Validate: fullName, bio, nativeLanguage, learningLanguage, location
    â”‚   â”‚       â”œâ”€â”€ Update: User.findByIdAndUpdate()
    â”‚   â”‚       â”œâ”€â”€ Stream: upsertStreamUser()
    â”‚   â”‚       â””â”€â”€ Response: 200 success + user data
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“„ user.controllers.js (USER MANAGEMENT CONTROLLERS)
    â”‚   â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: User, FriendRequest
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ‘¥ GET RECOMMENDED: getRecommendedUsers(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Get: currentUserId from req.user.id
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: User.find() with conditions
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Exclude: current user
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Exclude: existing friends
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Include: only onboarded users
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 + recommended users
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ‘« GET FRIENDS: getMyFriends(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: User.findById(req.user.id)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Select: "friends" field
    â”‚   â”‚   â”‚   â”œâ”€â”€ Populate: friends with specific fields
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 + friends array
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“¤ SEND REQUEST: sendFriendRequest(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Get: myId, recipientId
    â”‚   â”‚   â”‚   â”œâ”€â”€ Validate: not sending to self
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: recipient user
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: not already friends
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: no existing request
    â”‚   â”‚   â”‚   â”œâ”€â”€ Create: FriendRequest.create()
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 201 + friend request
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ âœ… ACCEPT REQUEST: acceptFriendRequest(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: FriendRequest.findById(requestId)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Validate: current user is recipient
    â”‚   â”‚   â”‚   â”œâ”€â”€ Check: status not already accepted
    â”‚   â”‚   â”‚   â”œâ”€â”€ Update: status = "accepted"
    â”‚   â”‚   â”‚   â”œâ”€â”€ Update: both users' friends arrays
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 success
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â”€ ğŸ“¥ GET INCOMING: getFriendRequest(req, res)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: pending requests (recipient: req.user.id)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Find: accepted requests (recipient: req.user.id)
    â”‚   â”‚   â”‚   â”œâ”€â”€ Populate: sender details
    â”‚   â”‚   â”‚   â””â”€â”€ Response: 200 + {incomingRequests, acceptedRequests}
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ ğŸ“¤ GET OUTGOING: getOutgoingFriendReqs(req, res)
    â”‚   â”‚       â”œâ”€â”€ Find: pending requests (sender: req.user.id)
    â”‚   â”‚       â”œâ”€â”€ Populate: recipient details
    â”‚   â”‚       â””â”€â”€ Response: 200 + outgoing requests
    â”‚   â”‚
    â”‚   â””â”€â”€ ğŸ“„ chat.controllers.js (CHAT CONTROLLERS)
    â”‚       â”œâ”€â”€ ğŸ”§ IMPORTS: generateStreamToken
    â”‚       â”‚
    â”‚       â””â”€â”€ ğŸ« GET STREAM TOKEN: getStreamToken(req, res)
    â”‚           â”œâ”€â”€ Generate: generateStreamToken(req.user.id)
    â”‚           â””â”€â”€ Response: 200 + {token}
    â”‚
    â””â”€â”€ ğŸ“ routes/
        â”œâ”€â”€ ğŸ“„ auth.route.js (AUTHENTICATION ROUTES)
        â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: Router, auth controllers, protectRoute
        â”‚   â”œâ”€â”€ ğŸ›£ï¸ ROUTES
        â”‚   â”‚   â”œâ”€â”€ POST /login â†’ login
        â”‚   â”‚   â”œâ”€â”€ POST /logout â†’ logout
        â”‚   â”‚   â”œâ”€â”€ POST /signup â†’ signup
        â”‚   â”‚   â”œâ”€â”€ POST /onboarding â†’ protectRoute + onboard
        â”‚   â”‚   â””â”€â”€ GET /me â†’ protectRoute + (req, res) => user info
        â”‚   â”‚
        â”‚   â””â”€â”€ ğŸ“¤ EXPORT: router
        â”‚
        â”œâ”€â”€ ğŸ“„ user.route.js (USER ROUTES)
        â”‚   â”œâ”€â”€ ğŸ”§ IMPORTS: Router, protectRoute, user controllers
        â”‚   â”œâ”€â”€ ğŸ›¡ï¸ MIDDLEWARE: router.use(protectRoute)
        â”‚   â”œâ”€â”€ ğŸ›£ï¸ ROUTES
        â”‚   â”‚   â”œâ”€â”€ GET / â†’ getRecommendedUsers
        â”‚   â”‚   â”œâ”€â”€ GET /friends â†’ getMyFriends
        â”‚   â”‚   â”œâ”€â”€ POST /friend-request/:id â†’ sendFriendRequest
        â”‚   â”‚   â”œâ”€â”€ PUT /friend-request/:id/accept â†’ acceptFriendRequest
        â”‚   â”‚   â”œâ”€â”€ GET /friend-request/ â†’ getFriendRequest
        â”‚   â”‚   â””â”€â”€ GET /outgoing-friend-request â†’ getOutgoingFriendReqs
        â”‚   â”‚
        â”‚   â””â”€â”€ ğŸ“¤ EXPORT: router
        â”‚
        â””â”€â”€ ğŸ“„ chat.route.js (CHAT ROUTES)
            â”œâ”€â”€ ğŸ”§ IMPORTS: Router, protectRoute, getStreamToken
            â”œâ”€â”€ ğŸ›£ï¸ ROUTES
            â”‚   â””â”€â”€ GET /token â†’ protectRoute + getStreamToken
            â”‚
            â””â”€â”€ ğŸ“¤ EXPORT: router

ğŸ“ notes/ (DOCUMENTATION)
â”œâ”€â”€ ğŸ“„ login.txt - Login flow diagram
â”œâ”€â”€ ğŸ“„ signup.txt - Signup flow diagram
â”œâ”€â”€ ğŸ“„ stream.txt - Stream Chat integration details
â””â”€â”€ ğŸ“„ project-tree.txt - This complete project structure

ğŸ”— DATA FLOW RELATIONSHIPS:
==========================

1. SERVER STARTUP FLOW:
   server.js â†’ connectDb() â†’ db.js â†’ MongoDB connection

2. AUTHENTICATION FLOW:
   auth.route.js â†’ auth.controllers.js â†’ User model â†’ bcrypt â†’ JWT â†’ cookie

3. USER MANAGEMENT FLOW:
   user.route.js â†’ user.controllers.js â†’ User/FriendRequest models â†’ MongoDB

4. CHAT FLOW:
   chat.route.js â†’ chat.controllers.js â†’ stream.js â†’ Stream Chat API

5. MIDDLEWARE FLOW:
   All protected routes â†’ auth.middleware.js â†’ JWT verification â†’ User lookup

6. STREAM INTEGRATION FLOW:
   auth.controllers.js â†’ stream.js â†’ Stream Chat API â†’ User creation/update

ğŸ” SECURITY LAYERS:
==================
1. Password Hashing: bcrypt in User model pre-save
2. JWT Authentication: jsonwebtoken in auth middleware
3. HTTP-only Cookies: Secure token storage
4. Input Validation: Controllers validate all inputs
5. Protected Routes: Middleware guards sensitive endpoints

ğŸ“Š DATABASE RELATIONSHIPS:
=========================
1. User â†’ User (friends array - self-referencing)
2. FriendRequest â†’ User (sender, recipient - many-to-one)
3. User â†” FriendRequest (one-to-many both ways)

ğŸŒ API STRUCTURE:
================
/api/auth/* - Authentication endpoints
/api/user/* - User management endpoints  
/api/chat/* - Chat functionality endpoints

All routes follow RESTful conventions with proper HTTP methods. 