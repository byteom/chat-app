STREAM.JS WORKFLOW TREE
========================

ğŸ“ backend/src/lib/stream.js
â”œâ”€â”€ ğŸ“¦ IMPORTS
â”‚   â”œâ”€â”€ import {StreamChat} from "stream-chat"
â”‚   â””â”€â”€ import dotenv from "dotenv"
â”‚
â”œâ”€â”€ âš™ï¸ CONFIGURATION
â”‚   â”œâ”€â”€ dotenv.config()
â”‚   â”œâ”€â”€ const apiKey = process.env.STREAM_API_KEY
â”‚   â”œâ”€â”€ const apiSecret = process.env.STREAM_API_SECRET
â”‚   â””â”€â”€ console.log("DEBUG: STREAM_API_KEY:", apiKey ? "LOADED" : "NOT FOUND!")
â”‚
â”œâ”€â”€ ğŸ”§ CLIENT INITIALIZATION
â”‚   â”œâ”€â”€ const streamClient = StreamChat.getInstance(apiKey, apiSecret)
â”‚   â””â”€â”€ console.log("DEBUG: Stream client initialized with API key:", apiKey ? "PRESENT" : "MISSING")
â”‚
â””â”€â”€ ğŸš€ EXPORTED FUNCTION: upsertStreamUser(userData)
    â”œâ”€â”€ ğŸ“¥ INPUT VALIDATION
    â”‚   â””â”€â”€ userData object containing: {id, name, image}
    â”‚
    â”œâ”€â”€ ğŸ”„ DATA TRANSFORMATION
    â”‚   â”œâ”€â”€ const streamUser = {
    â”‚   â”‚   â”œâ”€â”€ id: userData.id
    â”‚   â”‚   â”œâ”€â”€ name: userData.name
    â”‚   â”‚   â””â”€â”€ image: userData.image || ""
    â”‚   â”‚   â””â”€â”€ }
    â”‚   â””â”€â”€ console.log("DEBUG: About to call streamClient.upsertUsers with:", JSON.stringify([streamUser], null, 2))
    â”‚
    â”œâ”€â”€ ğŸŒ API CALL
    â”‚   â”œâ”€â”€ const result = await streamClient.upsertUsers([streamUser])
    â”‚   â””â”€â”€ console.log("DEBUG: Stream API response:", JSON.stringify(result, null, 2))
    â”‚
    â”œâ”€â”€ âœ… SUCCESS PATH
    â”‚   â”œâ”€â”€ console.log("Stream user created successfully:", streamUser.id)
    â”‚   â””â”€â”€ return userData
    â”‚
    â””â”€â”€ âŒ ERROR HANDLING
        â”œâ”€â”€ console.error("Error upserting Stream user:", error)
        â”œâ”€â”€ console.error("Error details:", error.message)
        â”œâ”€â”€ if (error.response) {
        â”‚   â””â”€â”€ console.error("Error response:", error.response.data)
        â”‚   â””â”€â”€ }
        â””â”€â”€ throw new Error("Failed to upsert Stream user")

USAGE FLOW:
==========
1. User signs up â†’ auth.controllers.js calls upsertStreamUser()
2. upsertStreamUser() transforms user data for Stream format
3. Makes API call to Stream Chat using upsertUsers()
4. Returns success or throws error
5. Controller handles response and continues signup process

ENVIRONMENT VARIABLES REQUIRED:
==============================
- STREAM_API_KEY: Your Stream Chat API key
- STREAM_API_SECRET: Your Stream Chat API secret

DEPENDENCIES:
============
- stream-chat: Stream Chat SDK
- dotenv: Environment variable management

ONBOARDING ISSUES & FIXES:
==========================

ğŸš¨ ISSUES FOUND:
â”œâ”€â”€ âŒ Typo in password validation: "legth" â†’ "length"
â”œâ”€â”€ âŒ Missing return statement in password validation
â”œâ”€â”€ âŒ Redundant save operation after User.create()
â”œâ”€â”€ âŒ Missing Stream user update in onboarding function
â””â”€â”€ âŒ Incomplete error handling in onboarding

âœ… FIXES APPLIED:
â”œâ”€â”€ âœ… Fixed password validation typo and added return
â”œâ”€â”€ âœ… Removed redundant newUser.save() call
â”œâ”€â”€ âœ… Added Stream user update in onboarding function
â”œâ”€â”€ âœ… Added proper error handling for Stream updates
â””â”€â”€ âœ… Added success logging for onboarding

ONBOARDING FLOW:
===============
1. User completes signup â†’ User created in MongoDB
2. User goes through onboarding â†’ Updates profile info
3. Onboarding function updates user in MongoDB
4. Onboarding function updates user in Stream Chat
5. Success response sent to frontend

AUTHENTICATION:
==============
- protectRoute middleware properly configured
- Onboarding route protected with authentication
- req.user populated correctly for onboarding function

401 UNAUTHORIZED TROUBLESHOOTING:
================================

ğŸš¨ ISSUE: Cookie Name Mismatch
â”œâ”€â”€ âŒ Middleware was looking for: req.cookies.jwt
â”œâ”€â”€ âŒ Controllers were setting: res.cookie("token", ...)
â””â”€â”€ âœ… FIXED: Updated middleware to use req.cookies.token

ğŸ” DEBUG STEPS:
1. Check if user is logged in (has valid token)
2. Check browser cookies for "token" cookie
3. Verify JWT_SECRET_KEY environment variable
4. Check if token is expired (7 days)
5. Verify user exists in database

ğŸ› DEBUG LOGS ADDED:
â”œâ”€â”€ console.log("DEBUG: Cookies received:", req.cookies)
â”œâ”€â”€ console.log("DEBUG: Token found:", token.substring(0, 20) + "...")
â”œâ”€â”€ console.log("DEBUG: Token decoded successfully, userId:", decoded.userId)
â””â”€â”€ console.log("DEBUG: No token found in cookies")

ğŸ”§ COMMON FIXES:
1. âœ… Cookie name mismatch fixed
2. âœ… Debug logging added
3. âœ… Cookie-parser middleware confirmed
4. âœ… JWT verification working

400 BAD REQUEST TROUBLESHOOTING:
================================

ğŸš¨ ISSUE: Missing Required Fields in Onboarding
â”œâ”€â”€ âŒ Onboarding requires: fullName, bio, nativeLanguage, learningLanguage, location
â”œâ”€â”€ âŒ Frontend might not be sending all required fields
â””â”€â”€ âœ… FIXED: Added detailed debugging to identify missing fields

ğŸ“‹ REQUIRED ONBOARDING FIELDS:
==============================
{
  "fullName": "string (required)",
  "bio": "string (required)", 
  "nativeLanguage": "string (required)",
  "learningLanguage": "string (required)",
  "location": "string (required)"
}

ğŸ” DEBUG STEPS:
1. Check request body in console logs
2. Verify all 5 required fields are present
3. Check field names match exactly (case-sensitive)
4. Ensure fields are not empty strings
5. Verify Content-Type is application/json

ğŸ› DEBUG LOGS ADDED:
â”œâ”€â”€ console.log("DEBUG: Onboarding request body:", JSON.stringify(req.body, null, 2))
â”œâ”€â”€ console.log("DEBUG: User ID from token:", req.user._id)
â”œâ”€â”€ console.log("DEBUG: Extracted fields:", {field: !!value})
â””â”€â”€ console.log("DEBUG: Missing fields:", {field: !value})

ğŸ“‹ TESTING CHECKLIST:
====================
â–¡ User signs up successfully
â–¡ Login returns 200 status
â–¡ Cookie is set with name "token"
â–¡ Onboarding route accepts authenticated requests
â–¡ Stream user is created/updated
â–¡ No 401 errors in console
â–¡ All required onboarding fields are sent
â–¡ Request body format is correct
â–¡ No 400 errors in console
